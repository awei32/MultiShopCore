# 用户模块数据库设计文档

## 一、数据库设计概述

### 1.1 设计原则

- **规范化设计**：遵循第三范式，减少数据冗余
- **性能优化**：合理设计索引，优化查询性能
- **扩展性**：支持水平分表和垂直分库
- **安全性**：敏感数据加密存储，权限控制
- **一致性**：保证数据完整性和事务一致性

### 1.2 数据库环境

| 项目 | 配置 | 说明 |
|------|------|------|
| 数据库类型 | MySQL | 8.0+ |
| 字符集 | utf8mb4 | 支持emoji和特殊字符 |
| 排序规则 | utf8mb4_unicode_ci | 大小写不敏感 |
| 存储引擎 | InnoDB | 支持事务和外键 |
| 时区 | Asia/Shanghai | 东八区 |

### 1.3 命名规范

- **表名**：小写字母，下划线分隔，前缀为模块名
- **字段名**：小写字母，下划线分隔，见名知意
- **索引名**：idx_表名_字段名 或 uk_表名_字段名
- **外键名**：fk_表名_关联表名_字段名

## 二、核心数据表设计

### 2.1 用户基础信息表 (user)

```sql
CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(255) NOT NULL COMMENT '密码(加密)',
  `salt` varchar(32) NOT NULL COMMENT '密码盐值',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `avatar` varchar(500) DEFAULT NULL COMMENT '头像URL',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `gender` tinyint DEFAULT '0' COMMENT '性别:0-未知,1-男,2-女',
  `birthday` date DEFAULT NULL COMMENT '生日',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT '状态:0-禁用,1-正常,2-锁定',
  `member_level` tinyint NOT NULL DEFAULT '1' COMMENT '会员等级:1-普通,2-银牌,3-金牌,4-钻石',
  `total_amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '累计消费金额',
  `total_points` int NOT NULL DEFAULT '0' COMMENT '累计积分',
  `available_points` int NOT NULL DEFAULT '0' COMMENT '可用积分',
  `register_source` varchar(20) DEFAULT 'web' COMMENT '注册来源:web,app,wechat,alipay',
  `register_ip` varchar(45) DEFAULT NULL COMMENT '注册IP',
  `last_login_time` datetime DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` varchar(45) DEFAULT NULL COMMENT '最后登录IP',
  `login_count` int NOT NULL DEFAULT '0' COMMENT '登录次数',
  `is_verified` tinyint NOT NULL DEFAULT '0' COMMENT '是否实名认证:0-否,1-是',
  `is_deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除:0-否,1-是',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `version` int NOT NULL DEFAULT '0' COMMENT '版本号(乐观锁)',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_username` (`username`),
  UNIQUE KEY `uk_user_email` (`email`),
  UNIQUE KEY `uk_user_phone` (`phone`),
  KEY `idx_user_status` (`status`),
  KEY `idx_user_member_level` (`member_level`),
  KEY `idx_user_create_time` (`create_time`),
  KEY `idx_user_login` (`phone`, `password`),
  KEY `idx_user_email_login` (`email`, `password`),
  KEY `idx_user_register_source` (`register_source`),
  KEY `idx_user_last_login` (`last_login_time`),
  KEY `idx_user_composite` (`status`, `member_level`, `create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户基础信息表';
```

### 2.2 用户详细资料表 (user_profile)

```sql
CREATE TABLE `user_profile` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `real_name` varchar(50) DEFAULT NULL COMMENT '真实姓名',
  `id_card` varchar(18) DEFAULT NULL COMMENT '身份证号',
  `profession` varchar(100) DEFAULT NULL COMMENT '职业',
  `company` varchar(200) DEFAULT NULL COMMENT '公司',
  `education` varchar(50) DEFAULT NULL COMMENT '学历',
  `income_level` varchar(20) DEFAULT NULL COMMENT '收入水平',
  `marital_status` tinyint DEFAULT '0' COMMENT '婚姻状况:0-未知,1-未婚,2-已婚,3-离异',
  `hobby` varchar(500) DEFAULT NULL COMMENT '兴趣爱好',
  `bio` text COMMENT '个人简介',
  `province` varchar(50) DEFAULT NULL COMMENT '省份',
  `city` varchar(50) DEFAULT NULL COMMENT '城市',
  `district` varchar(50) DEFAULT NULL COMMENT '区县',
  `address` varchar(200) DEFAULT NULL COMMENT '详细地址',
  `emergency_contact` varchar(50) DEFAULT NULL COMMENT '紧急联系人',
  `emergency_phone` varchar(20) DEFAULT NULL COMMENT '紧急联系电话',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_profile_user_id` (`user_id`),
  KEY `idx_profile_real_name` (`real_name`),
  KEY `idx_profile_location` (`province`, `city`),
  CONSTRAINT `fk_profile_user_id` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户详细资料表';
```

### 2.3 用户收货地址表 (user_address)

```sql
CREATE TABLE `user_address` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '地址ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `receiver_name` varchar(50) NOT NULL COMMENT '收货人姓名',
  `receiver_phone` varchar(20) NOT NULL COMMENT '收货人电话',
  `province` varchar(50) NOT NULL COMMENT '省份',
  `city` varchar(50) NOT NULL COMMENT '城市',
  `district` varchar(50) NOT NULL COMMENT '区县',
  `street` varchar(100) DEFAULT NULL COMMENT '街道',
  `detail_address` varchar(200) NOT NULL COMMENT '详细地址',
  `postal_code` varchar(10) DEFAULT NULL COMMENT '邮政编码',
  `address_tag` varchar(20) DEFAULT NULL COMMENT '地址标签:家,公司,学校等',
  `longitude` decimal(10,7) DEFAULT NULL COMMENT '经度',
  `latitude` decimal(10,7) DEFAULT NULL COMMENT '纬度',
  `is_default` tinyint NOT NULL DEFAULT '0' COMMENT '是否默认地址:0-否,1-是',
  `is_deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除:0-否,1-是',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_address_user_id` (`user_id`),
  KEY `idx_address_default` (`user_id`, `is_default`),
  KEY `idx_address_location` (`province`, `city`, `district`),
  KEY `idx_address_tag` (`address_tag`),
  CONSTRAINT `fk_address_user_id` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户收货地址表';
```

### 2.4 用户积分记录表 (user_points_log)

```sql
CREATE TABLE `user_points_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `order_id` bigint DEFAULT NULL COMMENT '关联订单ID',
  `points_type` tinyint NOT NULL COMMENT '积分类型:1-获得,2-消费,3-过期,4-退还',
  `points_amount` int NOT NULL COMMENT '积分数量',
  `points_balance` int NOT NULL COMMENT '积分余额',
  `source_type` varchar(20) NOT NULL COMMENT '来源类型:order,sign,activity,refund等',
  `source_id` bigint DEFAULT NULL COMMENT '来源ID',
  `description` varchar(200) DEFAULT NULL COMMENT '描述',
  `expire_time` datetime DEFAULT NULL COMMENT '过期时间',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_points_user_id` (`user_id`),
  KEY `idx_points_type` (`points_type`),
  KEY `idx_points_source` (`source_type`, `source_id`),
  KEY `idx_points_create_time` (`create_time`),
  KEY `idx_points_expire` (`expire_time`),
  KEY `idx_points_composite` (`user_id`, `points_type`, `create_time`),
  CONSTRAINT `fk_points_user_id` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户积分记录表';
```

### 2.5 用户会员等级表 (user_member_level)

```sql
CREATE TABLE `user_member_level` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '等级ID',
  `level_code` varchar(20) NOT NULL COMMENT '等级代码',
  `level_name` varchar(50) NOT NULL COMMENT '等级名称',
  `min_amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '最低消费金额',
  `max_amount` decimal(10,2) DEFAULT NULL COMMENT '最高消费金额',
  `discount_rate` decimal(3,2) NOT NULL DEFAULT '1.00' COMMENT '折扣率',
  `points_rate` decimal(3,2) NOT NULL DEFAULT '1.00' COMMENT '积分倍率',
  `free_shipping` tinyint NOT NULL DEFAULT '0' COMMENT '是否包邮:0-否,1-是',
  `birthday_discount` decimal(3,2) DEFAULT NULL COMMENT '生日折扣',
  `level_icon` varchar(200) DEFAULT NULL COMMENT '等级图标',
  `level_color` varchar(10) DEFAULT NULL COMMENT '等级颜色',
  `privileges` json DEFAULT NULL COMMENT '会员特权(JSON格式)',
  `sort_order` int NOT NULL DEFAULT '0' COMMENT '排序',
  `is_active` tinyint NOT NULL DEFAULT '1' COMMENT '是否启用:0-否,1-是',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_level_code` (`level_code`),
  KEY `idx_level_amount` (`min_amount`, `max_amount`),
  KEY `idx_level_sort` (`sort_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户会员等级表';
```

### 2.6 用户登录日志表 (user_login_log)

```sql
CREATE TABLE `user_login_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `login_type` varchar(20) NOT NULL COMMENT '登录类型:password,sms,wechat,alipay',
  `login_device` varchar(50) DEFAULT NULL COMMENT '登录设备',
  `login_ip` varchar(45) NOT NULL COMMENT '登录IP',
  `login_location` varchar(100) DEFAULT NULL COMMENT '登录地点',
  `user_agent` varchar(500) DEFAULT NULL COMMENT '用户代理',
  `login_status` tinyint NOT NULL COMMENT '登录状态:1-成功,0-失败',
  `fail_reason` varchar(100) DEFAULT NULL COMMENT '失败原因',
  `session_id` varchar(100) DEFAULT NULL COMMENT '会话ID',
  `login_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '登录时间',
  `logout_time` datetime DEFAULT NULL COMMENT '退出时间',
  PRIMARY KEY (`id`),
  KEY `idx_login_user_id` (`user_id`),
  KEY `idx_login_ip` (`login_ip`),
  KEY `idx_login_time` (`login_time`),
  KEY `idx_login_status` (`login_status`),
  KEY `idx_login_type` (`login_type`),
  KEY `idx_login_composite` (`user_id`, `login_status`, `login_time`),
  CONSTRAINT `fk_login_user_id` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户登录日志表';
```

### 2.7 用户第三方账号表 (user_oauth)

```sql
CREATE TABLE `user_oauth` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '绑定ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `oauth_type` varchar(20) NOT NULL COMMENT '第三方类型:wechat,alipay,qq,weibo',
  `oauth_id` varchar(100) NOT NULL COMMENT '第三方用户ID',
  `oauth_name` varchar(100) DEFAULT NULL COMMENT '第三方用户名',
  `oauth_avatar` varchar(500) DEFAULT NULL COMMENT '第三方头像',
  `access_token` varchar(500) DEFAULT NULL COMMENT '访问令牌',
  `refresh_token` varchar(500) DEFAULT NULL COMMENT '刷新令牌',
  `expires_in` int DEFAULT NULL COMMENT '令牌过期时间(秒)',
  `union_id` varchar(100) DEFAULT NULL COMMENT '开放平台统一ID',
  `extra_info` json DEFAULT NULL COMMENT '额外信息(JSON格式)',
  `bind_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '绑定时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_oauth_type_id` (`oauth_type`, `oauth_id`),
  KEY `idx_oauth_user_id` (`user_id`),
  KEY `idx_oauth_union_id` (`union_id`),
  CONSTRAINT `fk_oauth_user_id` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户第三方账号表';
```

### 2.8 用户消息表 (user_message)

```sql
CREATE TABLE `user_message` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '消息ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `message_type` varchar(20) NOT NULL COMMENT '消息类型:system,order,promotion,notice',
  `title` varchar(200) NOT NULL COMMENT '消息标题',
  `content` text NOT NULL COMMENT '消息内容',
  `link_url` varchar(500) DEFAULT NULL COMMENT '链接地址',
  `is_read` tinyint NOT NULL DEFAULT '0' COMMENT '是否已读:0-未读,1-已读',
  `read_time` datetime DEFAULT NULL COMMENT '阅读时间',
  `priority` tinyint NOT NULL DEFAULT '1' COMMENT '优先级:1-低,2-中,3-高',
  `sender_id` bigint DEFAULT NULL COMMENT '发送者ID',
  `sender_type` varchar(20) DEFAULT 'system' COMMENT '发送者类型:system,admin,merchant',
  `is_deleted` tinyint NOT NULL DEFAULT '0' COMMENT '是否删除:0-否,1-是',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_message_user_id` (`user_id`),
  KEY `idx_message_type` (`message_type`),
  KEY `idx_message_read` (`is_read`),
  KEY `idx_message_priority` (`priority`),
  KEY `idx_message_create_time` (`create_time`),
  KEY `idx_message_composite` (`user_id`, `is_read`, `create_time`),
  CONSTRAINT `fk_message_user_id` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户消息表';
```

### 2.9 用户偏好设置表 (user_preference)

```sql
CREATE TABLE `user_preference` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '设置ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `notification_email` tinyint NOT NULL DEFAULT '1' COMMENT '邮件通知:0-关闭,1-开启',
  `notification_sms` tinyint NOT NULL DEFAULT '1' COMMENT '短信通知:0-关闭,1-开启',
  `notification_push` tinyint NOT NULL DEFAULT '1' COMMENT '推送通知:0-关闭,1-开启',
  `privacy_profile` tinyint NOT NULL DEFAULT '1' COMMENT '资料可见性:0-私密,1-公开',
  `privacy_activity` tinyint NOT NULL DEFAULT '1' COMMENT '活动可见性:0-私密,1-公开',
  `language` varchar(10) NOT NULL DEFAULT 'zh-CN' COMMENT '语言设置',
  `timezone` varchar(50) NOT NULL DEFAULT 'Asia/Shanghai' COMMENT '时区设置',
  `currency` varchar(10) NOT NULL DEFAULT 'CNY' COMMENT '货币设置',
  `theme` varchar(20) NOT NULL DEFAULT 'light' COMMENT '主题设置:light,dark',
  `auto_login` tinyint NOT NULL DEFAULT '0' COMMENT '自动登录:0-关闭,1-开启',
  `marketing_email` tinyint NOT NULL DEFAULT '1' COMMENT '营销邮件:0-拒绝,1-接受',
  `marketing_sms` tinyint NOT NULL DEFAULT '1' COMMENT '营销短信:0-拒绝,1-接受',
  `data_analysis` tinyint NOT NULL DEFAULT '1' COMMENT '数据分析:0-拒绝,1-同意',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_preference_user_id` (`user_id`),
  CONSTRAINT `fk_preference_user_id` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户偏好设置表';
```

### 2.10 用户行为日志表 (user_behavior_log)

```sql
CREATE TABLE `user_behavior_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` bigint DEFAULT NULL COMMENT '用户ID',
  `session_id` varchar(100) DEFAULT NULL COMMENT '会话ID',
  `action_type` varchar(50) NOT NULL COMMENT '行为类型:view,click,search,purchase等',
  `action_target` varchar(100) DEFAULT NULL COMMENT '行为目标:product,category,page等',
  `target_id` bigint DEFAULT NULL COMMENT '目标ID',
  `action_detail` json DEFAULT NULL COMMENT '行为详情(JSON格式)',
  `page_url` varchar(500) DEFAULT NULL COMMENT '页面URL',
  `referrer_url` varchar(500) DEFAULT NULL COMMENT '来源URL',
  `user_agent` varchar(500) DEFAULT NULL COMMENT '用户代理',
  `ip_address` varchar(45) DEFAULT NULL COMMENT 'IP地址',
  `device_type` varchar(20) DEFAULT NULL COMMENT '设备类型:pc,mobile,tablet',
  `browser` varchar(50) DEFAULT NULL COMMENT '浏览器',
  `os` varchar(50) DEFAULT NULL COMMENT '操作系统',
  `duration` int DEFAULT NULL COMMENT '停留时长(秒)',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_behavior_user_id` (`user_id`),
  KEY `idx_behavior_session` (`session_id`),
  KEY `idx_behavior_action` (`action_type`),
  KEY `idx_behavior_target` (`action_target`, `target_id`),
  KEY `idx_behavior_time` (`create_time`),
  KEY `idx_behavior_composite` (`user_id`, `action_type`, `create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户行为日志表';
```

## 三、索引优化策略

### 3.1 主要查询场景分析

| 查询场景 | 频率 | 查询条件 | 优化策略 |
|----------|------|----------|----------|
| 用户登录 | 极高 | phone/email + password | 复合索引 |
| 用户信息查询 | 高 | user_id | 主键索引 |
| 地址列表查询 | 高 | user_id + is_default | 复合索引 |
| 积分记录查询 | 中 | user_id + create_time | 复合索引 |
| 消息列表查询 | 中 | user_id + is_read | 复合索引 |
| 行为日志分析 | 低 | action_type + create_time | 分区表 |

### 3.2 索引设计原则

```sql
-- 1. 高频查询优化
-- 用户登录查询优化
CREATE INDEX idx_user_login_phone ON user(phone, password, status);
CREATE INDEX idx_user_login_email ON user(email, password, status);

-- 2. 分页查询优化
-- 避免深分页问题，使用覆盖索引
CREATE INDEX idx_user_list_covering ON user(status, create_time, id, username, nickname);

-- 3. 统计查询优化
-- 会员等级统计
CREATE INDEX idx_user_member_stats ON user(member_level, status, create_time);

-- 4. 范围查询优化
-- 积分记录时间范围查询
CREATE INDEX idx_points_time_range ON user_points_log(user_id, create_time, points_type);

-- 5. 模糊查询优化
-- 用户搜索(需要配合全文索引)
ALTER TABLE user ADD FULLTEXT(username, nickname);
```

### 3.3 分区表设计

```sql
-- 用户行为日志表按月分区
CREATE TABLE `user_behavior_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` bigint DEFAULT NULL COMMENT '用户ID',
  -- ... 其他字段
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`, `create_time`),
  KEY `idx_behavior_user_id` (`user_id`),
  KEY `idx_behavior_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
PARTITION BY RANGE (YEAR(create_time) * 100 + MONTH(create_time)) (
  PARTITION p202401 VALUES LESS THAN (202402),
  PARTITION p202402 VALUES LESS THAN (202403),
  PARTITION p202403 VALUES LESS THAN (202404),
  -- ... 更多分区
  PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- 用户积分记录表按用户ID哈希分区
CREATE TABLE `user_points_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  -- ... 其他字段
  PRIMARY KEY (`id`, `user_id`),
  KEY `idx_points_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
PARTITION BY HASH(user_id) PARTITIONS 16;
```

## 四、数据安全设计

### 4.1 敏感数据加密

```sql
-- 创建加密函数
DELIMITER //
CREATE FUNCTION encrypt_sensitive_data(data VARCHAR(255), salt VARCHAR(32))
RETURNS VARCHAR(255)
READS SQL DATA
DETERMINISTIC
BEGIN
    RETURN AES_ENCRYPT(data, CONCAT(salt, 'your_secret_key'));
END //

CREATE FUNCTION decrypt_sensitive_data(encrypted_data VARCHAR(255), salt VARCHAR(32))
RETURNS VARCHAR(255)
READS SQL DATA
DETERMINISTIC
BEGIN
    RETURN AES_DECRYPT(encrypted_data, CONCAT(salt, 'your_secret_key'));
END //
DELIMITER ;

-- 敏感字段加密存储示例
-- 身份证号加密
UPDATE user_profile SET id_card = encrypt_sensitive_data(id_card, 'random_salt');

-- 手机号部分加密(保留前3位和后4位)
CREATE FUNCTION mask_phone(phone VARCHAR(20))
RETURNS VARCHAR(20)
READS SQL DATA
DETERMINISTIC
BEGIN
    IF LENGTH(phone) = 11 THEN
        RETURN CONCAT(LEFT(phone, 3), '****', RIGHT(phone, 4));
    ELSE
        RETURN phone;
    END IF;
END;
```

### 4.2 数据访问控制

```sql
-- 创建只读用户
CREATE USER 'readonly_user'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT ON multishop_user.* TO 'readonly_user'@'%';

-- 创建应用用户
CREATE USER 'app_user'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE ON multishop_user.* TO 'app_user'@'%';
GRANT DELETE ON multishop_user.user_login_log TO 'app_user'@'%';
GRANT DELETE ON multishop_user.user_behavior_log TO 'app_user'@'%';

-- 创建备份用户
CREATE USER 'backup_user'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT, LOCK TABLES ON multishop_user.* TO 'backup_user'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

### 4.3 审计日志

```sql
-- 创建数据变更审计表
CREATE TABLE `data_audit_log` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '审计ID',
  `table_name` varchar(50) NOT NULL COMMENT '表名',
  `operation_type` varchar(10) NOT NULL COMMENT '操作类型:INSERT,UPDATE,DELETE',
  `primary_key` varchar(100) NOT NULL COMMENT '主键值',
  `old_values` json DEFAULT NULL COMMENT '变更前数据',
  `new_values` json DEFAULT NULL COMMENT '变更后数据',
  `user_id` bigint DEFAULT NULL COMMENT '操作用户ID',
  `ip_address` varchar(45) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` varchar(500) DEFAULT NULL COMMENT '用户代理',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_audit_table` (`table_name`),
  KEY `idx_audit_operation` (`operation_type`),
  KEY `idx_audit_user` (`user_id`),
  KEY `idx_audit_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='数据审计日志表';

-- 创建触发器示例(用户表)
DELIMITER //
CREATE TRIGGER tr_user_audit_update
AFTER UPDATE ON user
FOR EACH ROW
BEGIN
    INSERT INTO data_audit_log (
        table_name, operation_type, primary_key, 
        old_values, new_values, create_time
    ) VALUES (
        'user', 'UPDATE', NEW.id,
        JSON_OBJECT(
            'username', OLD.username,
            'email', OLD.email,
            'phone', OLD.phone,
            'status', OLD.status
        ),
        JSON_OBJECT(
            'username', NEW.username,
            'email', NEW.email,
            'phone', NEW.phone,
            'status', NEW.status
        ),
        NOW()
    );
END //
DELIMITER ;
```

## 五、性能优化建议

### 5.1 查询优化

```sql
-- 1. 避免SELECT *，使用具体字段
-- 不推荐
SELECT * FROM user WHERE id = 1;

-- 推荐
SELECT id, username, nickname, avatar, status FROM user WHERE id = 1;

-- 2. 使用LIMIT限制结果集
-- 用户列表分页查询
SELECT id, username, nickname, create_time 
FROM user 
WHERE status = 1 
ORDER BY create_time DESC 
LIMIT 20 OFFSET 0;

-- 3. 使用EXISTS代替IN
-- 不推荐
SELECT * FROM user WHERE id IN (SELECT user_id FROM user_points_log WHERE points_amount > 100);

-- 推荐
SELECT * FROM user u WHERE EXISTS (
    SELECT 1 FROM user_points_log p WHERE p.user_id = u.id AND p.points_amount > 100
);

-- 4. 合理使用JOIN
-- 用户及其地址信息
SELECT u.id, u.username, a.detail_address
FROM user u
LEFT JOIN user_address a ON u.id = a.user_id AND a.is_default = 1
WHERE u.status = 1;
```

### 5.2 批量操作优化

```sql
-- 1. 批量插入
INSERT INTO user_points_log (user_id, points_type, points_amount, points_balance, source_type, create_time)
VALUES 
(1, 1, 100, 1100, 'order', NOW()),
(2, 1, 50, 550, 'order', NOW()),
(3, 1, 200, 1200, 'order', NOW());

-- 2. 批量更新
UPDATE user SET last_login_time = NOW() WHERE id IN (1, 2, 3, 4, 5);

-- 3. 使用ON DUPLICATE KEY UPDATE
INSERT INTO user_preference (user_id, notification_email, notification_sms)
VALUES (1, 1, 0)
ON DUPLICATE KEY UPDATE 
notification_email = VALUES(notification_email),
notification_sms = VALUES(notification_sms),
update_time = NOW();
```

### 5.3 缓存策略

```sql
-- 1. 查询结果缓存
-- 使用Redis缓存用户基础信息
-- Key: user:info:{user_id}
-- TTL: 30分钟

-- 2. 计数器缓存
-- 用户消息未读数量
-- Key: user:unread_count:{user_id}
-- TTL: 5分钟

-- 3. 热点数据预加载
-- 会员等级配置
-- Key: member:levels
-- TTL: 1小时
```

## 六、数据迁移与维护

### 6.1 数据迁移脚本

```sql
-- 历史数据迁移示例
-- 1. 用户数据迁移
INSERT INTO user (
    username, password, salt, email, phone, 
    status, register_source, create_time
)
SELECT 
    old_username, old_password, 'default_salt', 
    old_email, old_mobile, 1, 'migration', 
    old_create_time
FROM old_user_table
WHERE old_status = 'active';

-- 2. 地址数据迁移
INSERT INTO user_address (
    user_id, receiver_name, receiver_phone,
    province, city, district, detail_address,
    is_default, create_time
)
SELECT 
    u.id, oa.receiver_name, oa.receiver_phone,
    oa.province, oa.city, oa.district, oa.address,
    IF(oa.is_default = 'Y', 1, 0), oa.create_time
FROM old_address_table oa
JOIN user u ON u.username = oa.old_username;
```

### 6.2 数据清理策略

```sql
-- 1. 清理过期数据
-- 删除6个月前的登录日志
DELETE FROM user_login_log 
WHERE login_time < DATE_SUB(NOW(), INTERVAL 6 MONTH);

-- 删除1年前的行为日志
DELETE FROM user_behavior_log 
WHERE create_time < DATE_SUB(NOW(), INTERVAL 1 YEAR);

-- 2. 清理无效数据
-- 删除未激活超过30天的用户
DELETE FROM user 
WHERE status = 0 
AND create_time < DATE_SUB(NOW(), INTERVAL 30 DAY);

-- 3. 归档历史数据
-- 创建归档表
CREATE TABLE user_points_log_archive LIKE user_points_log;

-- 迁移历史数据
INSERT INTO user_points_log_archive 
SELECT * FROM user_points_log 
WHERE create_time < DATE_SUB(NOW(), INTERVAL 2 YEAR);

-- 删除已归档数据
DELETE FROM user_points_log 
WHERE create_time < DATE_SUB(NOW(), INTERVAL 2 YEAR);
```

### 6.3 定期维护任务

```sql
-- 1. 统计信息更新
ANALYZE TABLE user;
ANALYZE TABLE user_points_log;
ANALYZE TABLE user_behavior_log;

-- 2. 索引优化
OPTIMIZE TABLE user;
OPTIMIZE TABLE user_address;

-- 3. 数据一致性检查
-- 检查用户积分余额一致性
SELECT u.id, u.available_points, 
       COALESCE(SUM(CASE WHEN p.points_type = 1 THEN p.points_amount ELSE -p.points_amount END), 0) as calculated_points
FROM user u
LEFT JOIN user_points_log p ON u.id = p.user_id
GROUP BY u.id
HAVING u.available_points != calculated_points;

-- 检查默认地址唯一性
SELECT user_id, COUNT(*) as default_count
FROM user_address 
WHERE is_default = 1 AND is_deleted = 0
GROUP BY user_id
HAVING default_count > 1;
```

## 七、监控与告警

### 7.1 性能监控指标

```sql
-- 1. 慢查询监控
-- 开启慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;
SET GLOBAL log_queries_not_using_indexes = 'ON';

-- 2. 连接数监控
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Max_used_connections';

-- 3. 锁等待监控
SELECT * FROM information_schema.INNODB_LOCKS;
SELECT * FROM information_schema.INNODB_LOCK_WAITS;

-- 4. 表空间使用监控
SELECT 
    table_schema,
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size(MB)'
FROM information_schema.tables 
WHERE table_schema = 'multishop_user'
ORDER BY (data_length + index_length) DESC;
```

### 7.2 数据质量监控

```sql
-- 1. 数据完整性检查
-- 检查必填字段空值
SELECT COUNT(*) as null_username_count FROM user WHERE username IS NULL;
SELECT COUNT(*) as null_phone_count FROM user WHERE phone IS NULL;

-- 2. 数据格式检查
-- 检查手机号格式
SELECT COUNT(*) as invalid_phone_count 
FROM user 
WHERE phone IS NOT NULL 
AND phone NOT REGEXP '^1[3-9][0-9]{9}$';

-- 检查邮箱格式
SELECT COUNT(*) as invalid_email_count 
FROM user 
WHERE email IS NOT NULL 
AND email NOT REGEXP '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$';

-- 3. 业务逻辑检查
-- 检查积分余额异常
SELECT COUNT(*) as negative_points_count 
FROM user 
WHERE available_points < 0;

-- 检查会员等级异常
SELECT COUNT(*) as invalid_level_count 
FROM user 
WHERE member_level NOT IN (1, 2, 3, 4);
```

---

*本文档为用户模块数据库设计规格说明书，涵盖了表结构设计、索引优化、安全策略、性能优化等关键内容。*